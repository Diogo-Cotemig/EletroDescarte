<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Destino de Descarte</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="Ondedescarte.css" />
</head>
<body>

  <div class="mapa" id="mapa">
    <div id="distancia-destino"></div>
  </div>

  <div class="conteudo">
    <h2>O que você deseja fazer?</h2>
    <div class="opcoes">
      <div class="opcao">Buscar no Local</div>
      <div class="opcao" onclick="abrirModal()">Ponto de coleta mais próximo</div>
      <div class="opcao" onclick="abrirRota()">Levar na empresa</div>
    </div>
  </div>

  <div class="modal" id="modal">
    <div class="modal-content" id="modalContent">
      <button class="close-btn" onclick="fecharModal()">×</button>
      <h3>Qual item será descartado?</h3>
      <div class="botoes-itens">
        <button onclick="mostrarMensagem('Hardware')">Hardware</button>
        <button onclick="mostrarMensagem('Eletrodomésticos')">Eletrodomésticos</button>
        <button onclick="mostrarMensagem('Monitores')">Monitores</button>
        <button onclick="mostrarMensagem('Computador')">Computador</button>
        <button onclick="mostrarMensagem('Pilhas')">Pilhas</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script>
    // Armazena o conteúdo HTML original do modal para restaurar depois
    const originalModalContent = document.getElementById("modalContent").innerHTML;

    // Configuração do mapa
    const map = L.map('mapa').setView([-19.9191, -43.9386], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap'
    }).addTo(map);

    // Obter dados da URL
    const params = new URLSearchParams(window.location.search);
    const origem = params.get('origem');
    const endereco = params.get('endereco');
    const rotaJson = params.get('rota');
    const distancia = params.get('distancia');

    // Exibir a rota no mapa, se houver
    if (rotaJson) {
      try {
        const rota = JSON.parse(decodeURIComponent(rotaJson));
        const routeLayer = L.geoJSON(rota, {
          style: { color: "blue", weight: 5 }
        }).addTo(map);

        map.fitBounds(routeLayer.getBounds());
        
        // CORREÇÃO AQUI: Obtém as coordenadas exatas do início e do fim da rota
        const startPoint = rota.coordinates[0];
        const endPoint = rota.coordinates[rota.coordinates.length - 1];

        // Cria os marcadores usando as coordenadas reais (latitude, longitude)
        L.marker([startPoint[1], startPoint[0]]).addTo(map).bindPopup("Origem").openPopup();
        L.marker([endPoint[1], endPoint[0]]).addTo(map).bindPopup("Destino").openPopup();
        
        document.getElementById("distancia-destino").innerText = `🛣️ Distância: ${distancia} km`;

      } catch (e) {
        console.error("Erro ao carregar a rota:", e);
        exibirApenasDestino();
      }
    } else {
      exibirApenasDestino();
    }

    function exibirApenasDestino() {
        if (endereco) {
            async function geocodeAndSetView(endereco) {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(endereco)}`;
                const response = await fetch(url, {
                    headers: {
                        'Accept-Language': 'pt-BR',
                        'User-Agent': 'eletrodescarte/1.0'
                    }
                });
                const data = await response.json();
                if (data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    map.setView([lat, lon], 15);
                    L.marker([lat, lon]).addTo(map).bindPopup(endereco).openPopup();
                }
            }
            geocodeAndSetView(endereco);
        }
    }

    function abrirRota() {
      if (origem && endereco) {
        const rota = `https://www.google.com/maps/dir/${encodeURIComponent(origem)}/${encodeURIComponent(endereco)}`;
        window.open(rota, "_blank");
      } else {
        alert("Endereços de origem e destino não encontrados.");
      }
    }

    // Funções do Modal
    function abrirModal() {
      document.getElementById("modal").style.display = "flex";
    }

    function fecharModal() {
      document.getElementById("modal").style.display = "none";
      document.getElementById("modalContent").innerHTML = originalModalContent;
    }

    function mostrarMensagem(item) {
      let imagens = [];
      switch (item) {
        case 'Hardware':
          imagens = [
            'https://usagif.com/wp-content/uploads/gifs/globe-47.gif',
            'https://usagif.com/wp-content/uploads/gifs/globe-47.gif'
          ];
          break;
        case 'Eletrodomésticos':
          imagens = [
            'https://usagif.com/wp-content/uploads/gifs/globe-47.gif',
            'https://usagif.com/wp-content/uploads/gifs/globe-47.gif',
            'https://usagif.com/wp-content/uploads/gifs/globe-47.gif'
          ];
          break;
        case 'Monitores':
          imagens = [
            'https://usagif.com/wp-content/uploads/gifs/globe-47.gif',
            'https://usagif.com/wp-content/uploads/gifs/globe-47.gif',
            'https://usagif.com/wp-content/uploads/gifs/globe-47.gif'
          ];
          break;
        case 'Computador':
          imagens = [
            'https://usagif.com/wp-content/uploads/gifs/globe-47.gif'
          ];
          break;
        case 'Pilhas':
          imagens = [
            'https://usagif.com/wp-content/uploads/gifs/globe-47.gif',
            'https://usagif.com/wp-content/uploads/gifs/globe-47.gif'
          ];
          break;
        default:
          imagens = ['https://usagif.com/wp-content/uploads/gifs/globe-47.gif'];
      }

      const imagemTags = imagens.map(url => `<img src="${url}" alt="${item}" style="max-width: 150px; margin: 10px;">`).join('');
      const content = `
        <button class="close-btn" onclick="fecharModal()">×</button>
        <h2>Parabéns pelo descarte de ${item}!</h2>
        <p style="margin-top: 20px;">Você está contribuindo para um planeta mais limpo 🌱<br>
        Ao descartar corretamente, você protege o meio ambiente e inspira outros a fazer o mesmo.</br> Essa é a quantidade de terras que seriam gastas em um mundo sem você:</p>
        <div style="display: flex; flex-wrap: wrap; justify-content: center;">${imagemTags}</div>
      `;
      document.getElementById("modalContent").innerHTML = content;
    }
  </script>
</body>
</html>
